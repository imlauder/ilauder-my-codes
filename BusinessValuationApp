import numpy_financial as npf
from scipy.optimize import newton
import os
import sys
import subprocess
from pathlib import Path
import tkinter as tk
from tkinter import ttk, messagebox, simpledialog, filedialog
import webbrowser


def is_running_as_exe():
    return getattr(sys, 'frozen', False)


class BusinessValuationApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Business Valuation Tool")
        self.root.geometry("1000x800")
        self.style = ttk.Style()
        self.style.theme_use('clam')

        self.setup_ui()

    def setup_ui(self):
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.pack(fill=tk.BOTH, expand=True)

        header = ttk.Label(main_frame, text="Business Valuation Tool", font=('Helvetica', 16, 'bold'))
        header.pack(pady=10)

        self.notification = ttk.Label(main_frame, text="", foreground="red")
        self.notification.pack()

        self.notebook = ttk.Notebook(main_frame)
        self.notebook.pack(fill=tk.BOTH, expand=True, pady=10)

        self.setup_business_tab()
        self.setup_bond_tab()
        self.setup_re_tab()
        self.setup_fcfe_tab()
        self.setup_help_tab()

        ttk.Button(main_frame, text="–°–æ–∑–¥–∞—Ç—å EXE —Ñ–∞–π–ª", command=create_exe).pack(pady=10)

    def setup_business_tab(self):
        tab = ttk.Frame(self.notebook)
        self.notebook.add(tab, text="–û—Ü–µ–Ω–∫–∞ –±–∏–∑–Ω–µ—Å–∞/–∞–∫—Ü–∏–π")

        self.asset_type = tk.StringVar(value="–±–∏–∑–Ω–µ—Å")
        self.period_type = tk.StringVar(value="—Å—Ç–∞–Ω–¥–∞—Ä—Ç")
        self.custom_years = tk.StringVar()
        self.cf_values = []
        self.growth_rate = tk.StringVar(value="0.05")
        self.custom_growth_rate = tk.StringVar(value="0.05")
        self.discount_rate_type = tk.StringVar(value="manual")
        self.discount_rate = tk.StringVar(value="0.1")
        self.growth_rate_terminal = tk.StringVar(value="0.03")
        self.voi = tk.StringVar(value="0")
        self.price_paid = tk.StringVar()

        ttk.Label(tab, text="–¢–∏–ø –∞–∫—Ç–∏–≤–∞:").grid(row=0, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Combobox(tab, textvariable=self.asset_type, values=["–±–∏–∑–Ω–µ—Å", "–∞–∫—Ü–∏—è", "–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å"]).grid(row=0,
                                                                                                         column=1,
                                                                                                         sticky=tk.W,
                                                                                                         padx=5, pady=5)

        ttk.Label(tab, text="–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á–µ—Ç–∞:").grid(row=1, column=0, sticky=tk.W, padx=5, pady=5)
        period_frame = ttk.Frame(tab)
        period_frame.grid(row=1, column=1, sticky=tk.W, padx=5, pady=5)
        ttk.Radiobutton(period_frame, text="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (4 –≥–æ–¥–∞ + —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π –≥–æ–¥)",
                        variable=self.period_type, value="—Å—Ç–∞–Ω–¥–∞—Ä—Ç", command=self.update_business_ui).pack(side=tk.LEFT)
        ttk.Radiobutton(period_frame, text="–ö–∞—Å—Ç–æ–º–Ω—ã–π:", variable=self.period_type,
                        value="–∫–∞—Å—Ç–æ–º–Ω—ã–π", command=self.update_business_ui).pack(side=tk.LEFT)
        ttk.Entry(period_frame, textvariable=self.custom_years, width=5).pack(side=tk.LEFT)
        ttk.Label(period_frame, text="–ª–µ—Ç").pack(side=tk.LEFT)

        # CF –∑–∞ 1 –≥–æ–¥
        ttk.Label(tab, text="CF –∑–∞ 1 –≥–æ–¥:").grid(row=2, column=0, sticky=tk.W, padx=5, pady=5)
        self.cf1_entry = ttk.Entry(tab, width=10)
        self.cf1_entry.grid(row=2, column=1, sticky=tk.W, padx=5, pady=5)

        # –ì–æ–¥–æ–≤–æ–π —Ä–æ—Å—Ç (—Ä–∞–∑–Ω—ã–µ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–æ–≤)
        self.growth_frame = ttk.Frame(tab)
        self.growth_frame.grid(row=3, column=0, columnspan=2, sticky=tk.W, padx=5, pady=5)

        self.update_business_ui()

        ttk.Label(tab, text="–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:").grid(row=4, column=0, sticky=tk.W, padx=5, pady=5)
        discount_frame = ttk.Frame(tab)
        discount_frame.grid(row=4, column=1, sticky=tk.W, padx=5, pady=5)
        ttk.Radiobutton(discount_frame, text="–í—Ä—É—á–Ω—É—é:", variable=self.discount_rate_type, value="manual").pack(
            side=tk.LEFT)
        ttk.Entry(discount_frame, textvariable=self.discount_rate, width=5).pack(side=tk.LEFT, padx=5)
        ttk.Radiobutton(discount_frame, text="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å Re", variable=self.discount_rate_type,
                        value="re", command=lambda: self.notebook.select(2)).pack(side=tk.LEFT)

        ttk.Label(tab, text="–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç (g):").grid(row=5, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.growth_rate_terminal, width=5).grid(row=5, column=1, sticky=tk.W, padx=5,
                                                                             pady=5)

        ttk.Label(tab, text="VOI (–Ω–µ–ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤—ã):").grid(row=6, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.voi, width=10).grid(row=6, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–¶–µ–Ω–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è:").grid(row=7, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.price_paid, width=10).grid(row=7, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Button(tab, text="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å", command=self.calculate_business_value).grid(row=8, column=0, columnspan=2,
                                                                                       pady=10)

        self.result_text = tk.Text(tab, height=15, width=90, state=tk.DISABLED)
        self.result_text.grid(row=9, column=0, columnspan=2, padx=5, pady=5)

    def update_business_ui(self):
        # –û—á–∏—â–∞–µ–º —Ñ—Ä–µ–π–º —Å —Ä–æ—Å—Ç–æ–º
        for widget in self.growth_frame.winfo_children():
            widget.destroy()

        if self.period_type.get() == "—Å—Ç–∞–Ω–¥–∞—Ä—Ç":
            ttk.Label(self.growth_frame, text="–ì–æ–¥–æ–≤–æ–π —Ä–æ—Å—Ç CF –≤–æ 2-5 –≥–æ–¥—ã (%):").pack(side=tk.LEFT)
            ttk.Entry(self.growth_frame, textvariable=self.growth_rate, width=5).pack(side=tk.LEFT)
        else:
            ttk.Label(self.growth_frame, text="–ì–æ–¥–æ–≤–æ–π —Ä–æ—Å—Ç CF –∑–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (%):").pack(side=tk.LEFT)
            ttk.Entry(self.growth_frame, textvariable=self.custom_growth_rate, width=5).pack(side=tk.LEFT)

    def setup_bond_tab(self):
        tab = ttk.Frame(self.notebook)
        self.notebook.add(tab, text="–û—Ü–µ–Ω–∫–∞ –æ–±–ª–∏–≥–∞—Ü–∏–π")

        self.bond_years = tk.StringVar(value="1")
        self.bond_cf_values = []
        self.bond_price = tk.StringVar()
        self.bond_nominal = tk.StringVar(value="1000")

        ttk.Label(tab, text="–ü–µ—Ä–∏–æ–¥ –¥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è (–ª–µ—Ç):").grid(row=0, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.bond_years, width=5).grid(row=0, column=1, sticky=tk.W, padx=5, pady=5)

        self.bond_years.trace_add("write", self.update_bond_cf_entries)

        ttk.Label(tab, text="–ö—É–ø–æ–Ω–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã:").grid(row=1, column=0, sticky=tk.W, padx=5, pady=5)
        self.bond_cf_frame = ttk.Frame(tab)
        self.bond_cf_frame.grid(row=1, column=1, columnspan=2, sticky=tk.W, padx=5, pady=5)

        self.bond_cf_entries = []
        self.setup_bond_cf_entries(1)

        ttk.Label(tab, text="–ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:").grid(row=2, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.bond_nominal, width=10).grid(row=2, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–¶–µ–Ω–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è:").grid(row=3, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.bond_price, width=10).grid(row=3, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Button(tab, text="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å YTM", command=self.calculate_bond_value).grid(row=4, column=0, columnspan=2,
                                                                                       pady=10)

        self.bond_result_text = tk.Text(tab, height=15, width=90, state=tk.DISABLED)
        self.bond_result_text.grid(row=5, column=0, columnspan=2, padx=5, pady=5)

    def update_bond_cf_entries(self, *args):
        try:
            years = float(self.bond_years.get())
            full_years = int(years)
            fractional_part = years - full_years

            # –î–ª—è –Ω–µ—Ü–µ–ª—ã—Ö –ª–µ—Ç –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            num_entries = full_years + 1 if fractional_part > 0 else full_years
            self.setup_bond_cf_entries(num_entries)
        except ValueError:
            pass

    def setup_bond_cf_entries(self, num_entries):
        for widget in self.bond_cf_frame.winfo_children():
            widget.destroy()

        self.bond_cf_entries = []
        for i in range(num_entries):
            row = ttk.Frame(self.bond_cf_frame)
            row.pack(fill=tk.X)

            if i < num_entries - 1:
                label_text = f"–ö—É–ø–æ–Ω {i + 1}:"
            else:
                label_text = f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥:"

            ttk.Label(row, text=label_text).pack(side=tk.LEFT)
            entry = ttk.Entry(row, width=10)
            entry.pack(side=tk.LEFT, padx=5)
            self.bond_cf_entries.append(entry)

    def setup_re_tab(self):
        tab = ttk.Frame(self.notebook)
        self.notebook.add(tab, text="–†–∞—Å—á–µ—Ç Re")

        self.beta_u = tk.StringVar(value="1.0")
        self.tax_rate = tk.StringVar(value="0.2")
        self.debt_value = tk.StringVar(value="100")
        self.equity_value = tk.StringVar(value="100")
        self.erp_usa = tk.StringVar(value="0.05")
        self.us_intr = tk.StringVar(value="0.03")
        self.country_rf = tk.StringVar(value="0.05")
        self.country_data = []

        ttk.Label(tab, text="Beta U (–æ—Ç—Ä–∞—Å–ª–µ–≤–∞—è –±–µ—Ç–∞ –±–µ–∑ –¥–æ–ª–≥–∞):").grid(row=0, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.beta_u, width=10).grid(row=0, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞:").grid(row=1, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.tax_rate, width=10).grid(row=1, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–≥–∞ (D):").grid(row=2, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.debt_value, width=10).grid(row=2, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–†—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–ø–∏—Ç–∞–ª–∞ (E):").grid(row=3, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.equity_value, width=10).grid(row=3, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="ERP USA:").grid(row=4, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.erp_usa, width=10).grid(row=4, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="USINTR (–±–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –°–®–ê):").grid(row=5, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.us_intr, width=10).grid(row=5, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–ë–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–∞–Ω—ã (Rf):").grid(row=6, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.country_rf, width=10).grid(row=6, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Button(tab, text="–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É", command=self.add_country).grid(row=7, column=0, columnspan=2, pady=10)

        self.country_frame = ttk.Frame(tab)
        self.country_frame.grid(row=8, column=0, columnspan=2, sticky=tk.W, padx=5, pady=5)

        ttk.Button(tab, text="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å Re", command=self.calculate_re_gui).grid(row=9, column=0, columnspan=2,
                                                                                  pady=10)

        self.re_result_text = tk.Text(tab, height=10, width=90, state=tk.DISABLED)
        self.re_result_text.grid(row=10, column=0, columnspan=2, padx=5, pady=5)

    def setup_fcfe_tab(self):
        tab = ttk.Frame(self.notebook)
        self.notebook.add(tab, text="–†–∞—Å—á–µ—Ç g FCFE")

        self.fcfe_growth = tk.StringVar(value="0.1")
        self.capex_prev = tk.StringVar(value="100")
        self.ocf = tk.StringVar(value="200")
        self.roic_fcfe = tk.StringVar()
        self.reinv_rate = tk.StringVar()
        self.g_fcfe = tk.StringVar()

        ttk.Label(tab, text="–†–æ—Å—Ç FCFE (FCFE Growth):").grid(row=0, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.fcfe_growth, width=10).grid(row=0, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="CapEx –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥–æ–¥–∞:").grid(row=1, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.capex_prev, width=10).grid(row=1, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Label(tab, text="–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (OCF):").grid(row=2, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.ocf, width=10).grid(row=2, column=1, sticky=tk.W, padx=5, pady=5)

        ttk.Button(tab, text="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å g FCFE", command=self.calculate_fcfe).grid(row=3, column=0, columnspan=2,
                                                                                    pady=10)

        ttk.Label(tab, text="ROIC FCFE:").grid(row=4, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.roic_fcfe, state='readonly', width=10).grid(row=4, column=1, sticky=tk.W,
                                                                                     padx=5, pady=5)

        ttk.Label(tab, text="Reinvestment Rate:").grid(row=5, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.reinv_rate, state='readonly', width=10).grid(row=5, column=1, sticky=tk.W,
                                                                                      padx=5, pady=5)

        ttk.Label(tab, text="g FCFE:").grid(row=6, column=0, sticky=tk.W, padx=5, pady=5)
        ttk.Entry(tab, textvariable=self.g_fcfe, state='readonly', width=10).grid(row=6, column=1, sticky=tk.W, padx=5,
                                                                                  pady=5)

    def calculate_fcfe(self):
        try:
            fcfe_growth = float(self.fcfe_growth.get())
            capex_prev = float(self.capex_prev.get())
            ocf = float(self.ocf.get())

            roic_fcfe = fcfe_growth / capex_prev if capex_prev != 0 else 0
            reinv_rate = capex_prev / ocf if ocf != 0 else 0
            g_fcfe = roic_fcfe * reinv_rate

            self.roic_fcfe.set(f"{roic_fcfe:.4f}")
            self.reinv_rate.set(f"{reinv_rate:.4f}")
            self.g_fcfe.set(f"{g_fcfe:.4f}")

        except Exception as e:
            messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ g FCFE: {str(e)}")

    def add_country(self):
        country_window = tk.Toplevel(self.root)
        country_window.title("–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω—É")

        country_intr = tk.StringVar(value="0.05")
        crp = tk.StringVar(value="0.03")
        lambda_val = tk.StringVar(value="1.0")

        ttk.Label(country_window, text="–ë–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–∞–Ω—ã:").grid(row=0, column=0, padx=5, pady=5)
        ttk.Entry(country_window, textvariable=country_intr, width=10).grid(row=0, column=1, padx=5, pady=5)

        ttk.Label(country_window, text="CRP (—Å—Ç—Ä–∞–Ω–æ–≤–æ–π —Ä–∏—Å–∫ –ø—Ä–µ–º–∏—É–º):").grid(row=1, column=0, padx=5, pady=5)
        ttk.Entry(country_window, textvariable=crp, width=10).grid(row=1, column=1, padx=5, pady=5)

        ttk.Label(country_window, text="Lambda (–¥–æ–ª—è –≤—ã—Ä—É—á–∫–∏):").grid(row=2, column=0, padx=5, pady=5)
        ttk.Entry(country_window, textvariable=lambda_val, width=10).grid(row=2, column=1, padx=5, pady=5)

        def save_country():
            self.country_data.append({
                'country_intr': float(country_intr.get()),
                'crp': float(crp.get()),
                'lambda_val': float(lambda_val.get())
            })
            self.update_country_list()
            country_window.destroy()

        ttk.Button(country_window, text="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", command=save_country).grid(row=3, column=0, columnspan=2, pady=10)

    def update_country_list(self):
        for widget in self.country_frame.winfo_children():
            widget.destroy()

        for i, country in enumerate(self.country_data):
            row = ttk.Frame(self.country_frame)
            row.pack(fill=tk.X)
            ttk.Label(row,
                      text=f"–°—Ç—Ä–∞–Ω–∞ {i + 1}: INTR={country['country_intr']}, CRP={country['crp']}, Œª={country['lambda_val']}").pack(
                side=tk.LEFT)

            ttk.Button(row, text="–£–¥–∞–ª–∏—Ç—å", command=lambda idx=i: self.remove_country(idx)).pack(side=tk.RIGHT)

    def remove_country(self, idx):
        self.country_data.pop(idx)
        self.update_country_list()

    def calculate_business_value(self):
        try:
            asset_type = self.asset_type.get()

            if self.period_type.get() == "—Å—Ç–∞–Ω–¥–∞—Ä—Ç":
                years = 5  # 4 –≥–æ–¥–∞ + —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π
                use_standard_formula = True
                growth_rate = float(self.growth_rate.get())
            else:
                years = float(self.custom_years.get())
                use_standard_formula = False
                growth_rate = float(self.custom_growth_rate.get())

            cf_values = []
            full_years = int(years)
            fractional_part = years - full_years

            cf1 = float(self.cf1_entry.get())
            cf_values.append((cf1, 1.0))

            if use_standard_formula:
                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç (4 –≥–æ–¥–∞ + —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π)
                for i in range(1, 5):
                    cf = cf_values[-1][0] * (1 + growth_rate)
                    cf_values.append((cf, 1.0))
            else:
                # –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ä–∞—Å—á–µ—Ç
                for i in range(1, full_years):
                    cf = cf_values[-1][0] * (1 + growth_rate)
                    cf_values.append((cf, 1.0))

                if fractional_part > 0:
                    cf = cf_values[-1][0] * (1 + growth_rate)
                    cf_values.append((cf, fractional_part))

            if self.discount_rate_type.get() == "manual":
                k = float(self.discount_rate.get())
            else:
                k = self.calculate_re()

            g = float(self.growth_rate_terminal.get())
            voi = float(self.voi.get())
            price_paid = float(self.price_paid.get())

            ev = 0
            if use_standard_formula:
                for t in range(4):
                    ev += cf_values[t][0] / ((1 + k) ** (t + 1))
                terminal_value = (cf_values[4][0] * (1 + g)) / (k - g) / ((1 + k) ** 5)
                ev += terminal_value
            else:
                time_passed = 0
                for i, (cf, duration) in enumerate(cf_values):
                    time_passed += duration
                    ev += cf / ((1 + k) ** time_passed)
            ev += voi

            result = f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞:\n"
            result += f"–¢–∏–ø –∞–∫—Ç–∏–≤–∞: {asset_type}\n"
            result += f"–ü–µ—Ä–∏–æ–¥ —Ä–∞—Å—á–µ—Ç–∞: {years} –ª–µ—Ç\n"
            result += f"–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (k): {k:.4f}\n"
            result += f"–¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç (g): {g:.4f}\n"
            result += f"VOI: {voi:.2f}\n"
            result += f"\n–°—Ç–æ–∏–º–æ—Å—Ç—å (EV): {ev:.2f}\n"
            result += f"–¶–µ–Ω–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è: {price_paid:.2f}\n"

            difference = ev - price_paid
            percent_difference = (difference / ev) * 100
            result += f"\n–†–∞–∑–Ω–∏—Ü–∞ (EV - —Ü–µ–Ω–∞): {difference:.2f} ({percent_difference:.2f}% –æ—Ç EV)\n"

            if difference > 0:
                result += "‚úÖ –í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫—Ç–∏–≤ –¥–µ—à–µ–≤–ª–µ –µ–≥–æ —Ä–∞—Å—á–µ—Ç–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (EV > —Ü–µ–Ω–∞)"
            elif difference < 0:
                result += "‚ö†Ô∏è –í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫—Ç–∏–≤ –¥–æ—Ä–æ–∂–µ –µ–≥–æ —Ä–∞—Å—á–µ—Ç–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (EV < —Ü–µ–Ω–∞)"
            else:
                result += "‚öñÔ∏è –í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ –∞–∫—Ç–∏–≤ —Ä–æ–≤–Ω–æ –ø–æ –µ–≥–æ —Ä–∞—Å—á–µ—Ç–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (EV = —Ü–µ–Ω–∞)"

            self.show_result(result)

        except Exception as e:
            self.show_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: {str(e)}")

    def calculate_bond_value(self):
        try:
            years = float(self.bond_years.get())
            full_years = int(years)
            fractional_part = years - full_years

            cf_values = []
            for i in range(full_years):
                cf = float(self.bond_cf_entries[i].get())
                cf_values.append((cf, 1.0))

            if fractional_part > 0:
                cf = float(self.bond_cf_entries[full_years].get()) + float(self.bond_nominal.get())
                cf_values.append((cf, fractional_part))
            else:
                cf_values[-1] = (cf_values[-1][0] + float(self.bond_nominal.get()), cf_values[-1][1])

            price_paid = float(self.bond_price.get())

            cashflows = [-price_paid] + [cf[0] for cf in cf_values]
            durations = [cf[1] for cf in cf_values]
            time_points = []
            acc_time = 0
            for d in durations:
                acc_time += d
                time_points.append(acc_time)

            def ytm_func(r):
                return sum(cf / (1 + r) ** t for cf, t in zip(cashflows[1:], time_points)) + cashflows[0]

            try:
                ytm = newton(ytm_func, x0=0.1)

                result = f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ –æ–±–ª–∏–≥–∞—Ü–∏–∏:\n"
                result += f"–ü–µ—Ä–∏–æ–¥ –¥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è: {years:.2f} –ª–µ—Ç\n"
                result += f"–¶–µ–Ω–∞ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è: {price_paid:.2f}\n"
                result += f"–ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {float(self.bond_nominal.get()):.2f}\n"
                result += f"\n–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∫ –ø–æ–≥–∞—à–µ–Ω–∏—é (YTM): {ytm * 100:.2f}% –≥–æ–¥–æ–≤—ã—Ö\n"

                pv_cashflows = [cf / (1 + ytm) ** t for cf, t in zip(cashflows[1:], time_points)]
                duration = sum(t * pv for t, pv in zip(time_points, pv_cashflows)) / sum(pv_cashflows)
                result += f"–î—é—Ä–∞—Ü–∏—è –æ–±–ª–∏–≥–∞—Ü–∏–∏: {duration:.2f} –ª–µ—Ç\n"

                price_up = sum(cf / (1 + ytm + 0.01) ** t for cf, t in zip(cashflows[1:], time_points))
                price_down = sum(cf / (1 + ytm - 0.01) ** t for cf, t in zip(cashflows[1:], time_points))

                delta_up = price_up - price_paid
                delta_down = price_down - price_paid
                percent_up = (delta_up / price_paid) * 100
                percent_down = (delta_down / price_paid) * 100

                result += f"\nüî∫ –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏ –Ω–∞ 1%:\n"
                result += f"- –ù–æ–≤–∞—è —Ü–µ–Ω–∞: {price_up:.2f} (–∏–∑–º–µ–Ω–µ–Ω–∏–µ: {delta_up:+.2f}, {percent_up:+.2f}%)\n"
                result += f"\nüîª –ü—Ä–∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏ –Ω–∞ 1%:\n"
                result += f"- –ù–æ–≤–∞—è —Ü–µ–Ω–∞: {price_down:.2f} (–∏–∑–º–µ–Ω–µ–Ω–∏–µ: {delta_down:+.2f}, {percent_down:+.2f}%)\n"

                self.show_bond_result(result)

            except RuntimeError:
                self.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å YTM. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ.")

        except Exception as e:
            self.show_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏: {str(e)}")

    def calculate_re_gui(self):
        try:
            beta_u = float(self.beta_u.get())
            tax = float(self.tax_rate.get())
            D = float(self.debt_value.get())
            E = float(self.equity_value.get())

            beta_l = beta_u * (1 + (1 - tax) * (D / E))

            erp_usa = float(self.erp_usa.get())
            us_intr = float(self.us_intr.get())

            erp_local = 0
            for country in self.country_data:
                country_erp = country['lambda_val'] * (
                            (erp_usa + 1 * country['crp']) + (country['country_intr'] - us_intr))
                erp_local += country_erp

            rf = float(self.country_rf.get())
            re = rf + beta_l * erp_local

            result = f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ Re:\n"
            result += f"Beta U: {beta_u:.4f}\n"
            result += f"Beta L (–ª–µ–≤–µ—Ä–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–µ—Ç–∞): {beta_l:.4f}\n"
            result += f"ERP Local: {erp_local:.4f}\n"
            result += f"–ë–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (Rf): {rf:.4f}\n"
            result += f"\n‚úÖ –ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ Re = {re:.4f}\n"

            self.discount_rate.set(f"{re:.4f}")
            self.discount_rate_type.set("manual")

            self.show_re_result(result)

        except Exception as e:
            self.show_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ Re: {str(e)}")

    def calculate_re(self):
        try:
            beta_u = float(self.beta_u.get())
            tax = float(self.tax_rate.get())
            D = float(self.debt_value.get())
            E = float(self.equity_value.get())

            beta_l = beta_u * (1 + (1 - tax) * (D / E))

            erp_usa = float(self.erp_usa.get())
            us_intr = float(self.us_intr.get())

            erp_local = 0
            for country in self.country_data:
                country_erp = country['lambda_val'] * (
                            (erp_usa + 1 * country['crp']) + (country['country_intr'] - us_intr))
                erp_local += country_erp

            rf = float(self.country_rf.get())
            re = rf + beta_l * erp_local

            return re

        except Exception as e:
            self.show_error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ Re: {str(e)}")
            return 0.1

    def show_result(self, text):
        self.result_text.config(state=tk.NORMAL)
        self.result_text.delete(1.0, tk.END)
        self.result_text.insert(tk.END, text)
        self.result_text.config(state=tk.DISABLED)

    def show_bond_result(self, text):
        self.bond_result_text.config(state=tk.NORMAL)
        self.bond_result_text.delete(1.0, tk.END)
        self.bond_result_text.insert(tk.END, text)
        self.bond_result_text.config(state=tk.DISABLED)

    def show_re_result(self, text):
        self.re_result_text.config(state=tk.NORMAL)
        self.re_result_text.delete(1.0, tk.END)
        self.re_result_text.insert(tk.END, text)
        self.re_result_text.config(state=tk.DISABLED)

    def show_error(self, message):
        messagebox.showerror("–û—à–∏–±–∫–∞", message)

    def setup_help_tab(self):
        tab = ttk.Frame(self.notebook)
        self.notebook.add(tab, text="–°–ø—Ä–∞–≤–∫–∞")

        help_text = """
        Business Valuation Tool - –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Ü–∏–π, –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, –±–∏–∑–Ω–µ—Å–∞ –∏ –æ–±–ª–∏–≥–∞—Ü–∏–π.

        –§—É–Ω–∫—Ü–∏–∏:
        1. –û—Ü–µ–Ω–∫–∞ –±–∏–∑–Ω–µ—Å–∞/–∞–∫—Ü–∏–π/–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –ø–æ –º–æ–¥–µ–ª–∏ DCF
        2. –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –æ–±–ª–∏–≥–∞—Ü–∏–π (YTM)
        3. –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞ (Re)
        4. –†–∞—Å—á–µ—Ç g FCFE (—Ç–µ–º–ø —Ä–æ—Å—Ç–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –Ω–∞ –∫–∞–ø–∏—Ç–∞–ª)

        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
        - –î–ª—è –æ—Ü–µ–Ω–∫–∏ –±–∏–∑–Ω–µ—Å–∞/–∞–∫—Ü–∏–π/–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–û—Ü–µ–Ω–∫–∞ –±–∏–∑–Ω–µ—Å–∞/–∞–∫—Ü–∏–π"
        - –î–ª—è –æ—Ü–µ–Ω–∫–∏ –æ–±–ª–∏–≥–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–û—Ü–µ–Ω–∫–∞ –æ–±–ª–∏–≥–∞—Ü–∏–π"
        - –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–†–∞—Å—á–µ—Ç Re"
        - –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ g FCFE –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–†–∞—Å—á–µ—Ç g FCFE"
        """
        ttk.Label(tab, text=help_text, justify=tk.LEFT).pack(padx=10, pady=10)


def create_exe():
    try:
        try:
            import PyInstaller
        except ImportError:
            print("\n–£—Å—Ç–∞–Ω–æ–≤–∫–∞ PyInstaller...")
            subprocess.check_call([sys.executable, "-m", "pip", "install", "pyinstaller"])

        script_path = Path(__file__).resolve()

        command = [
            sys.executable,
            '-m',
            'PyInstaller',
            '--onefile',
            '--windowed',
            '--name=BusinessValuationTool',
            str(script_path)
        ]

        print("\n–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏:")
        print(' '.join(command))

        print("\n–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É EXE... (—ç—Ç–æ –∑–∞–π–º–µ—Ç 1-3 –º–∏–Ω—É—Ç—ã)")
        subprocess.run(command, check=True)

        messagebox.showinfo("–£—Å–ø–µ—Ö", "EXE-—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ –ø–∞–ø–∫–µ 'dist'")
    except Exception as e:
        messagebox.showerror("–û—à–∏–±–∫–∞", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ EXE-—Ñ–∞–π–ª–∞: {str(e)}")


if __name__ == "__main__":
    root = tk.Tk()
    app = BusinessValuationApp(root)
    root.mainloop()
