import customtkinter as ctk
import math
import sys

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –Ω—É–ª–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
EPSILON = 1e-9


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø 1: –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø V1=V0 (–†–∞–∑–¥–µ–ª 1)
# ====================================================================
def calculate_compensating_basket(V0, E0, R0, i_USD, i_EUR, i_RUB, r_USD_prime, r_EUR_prime, r_RUB_prime, base_currency):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ –õ–û–ì–ò–ö–ï –î–í–û–ô–ù–û–ô –ö–û–ú–ü–ï–ù–°–ê–¶–ò–ò —Å –í–´–ë–û–†–û–ú –ë–ê–ó–û–í–û–ô –í–ê–õ–Æ–¢–´,
    –∏—Å–ø–æ–ª—å–∑—É—è –ü–ï–†–ï–ë–†–û–®–ï–ù–ù–£–Æ –î–û–•–û–î–ù–û–°–¢–¨ –û–ë–õ–ò–ì–ê–¶–ò–ô (r_prime).
    """

    # –†–∞—Å—á–µ—Ç Delta
    # EURUSD: (i_USD - i_EUR) + (r'_USD - r'_EUR)
    C_Base_EUR = i_USD - i_EUR
    C_Corr_EUR = r_USD_prime - r_EUR_prime 
    Delta_EURUSD = C_Base_EUR + C_Corr_EUR

    # USDRUB: (i_RUB - i_USD) + (r'_RUB - r'_USD)
    C_Base_RUB = i_RUB - i_USD
    C_Corr_RUB = r_RUB_prime - r_USD_prime
    Delta_USDRUB = C_Base_RUB + C_Corr_RUB

    # –ü—Ä–æ–≥–Ω–æ–∑ –æ–∂–∏–¥–∞–µ–º—ã—Ö –∫—É—Ä—Å–æ–≤ (t=1).
    E1 = E0 * (1 + Delta_EURUSD)
    R1 = R0 * (1 + Delta_USDRUB)

    # –ü–µ—Ä–µ—Å—á–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç—á–µ—Ç–µ
    C_Base_RUB_Report = i_RUB - i_USD
    C_Corr_RUB_Report = r_RUB_prime - r_USD_prime 

    # --- –ê–î–ê–ü–¢–ê–¶–ò–Ø –ö –ë–ê–ó–û–í–û–ô –í–ê–õ–Æ–¢–ï –ò –†–ê–°–ß–ï–¢ K-–ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í ---
    if base_currency == "USD":
        Base_V0 = V0
        Base_Label = "USD"

        K_USD = 1.0
        K_EUR = (E1 / E0)
        K_RUB = (R0 / R1)

        V0_conv_USD = 1
        V0_conv_EUR = E0
        V0_conv_RUB = 1 / R0

    elif base_currency == "EUR":
        Base_V0 = V0 / E0
        Base_Label = "EUR"

        K_EUR = 1.0
        K_USD = E0 / E1
        K_RUB = (E0 / E1) * (R0 / R1)

        V0_conv_USD = 1 / E0
        V0_conv_EUR = 1
        V0_conv_RUB = (1 / R0) / E0

    else:
        raise ValueError("–ù–µ–≤–µ—Ä–Ω–∞—è –±–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞.")

    currencies = {
        "USD": {"K": K_USD, "r": r_USD_prime, "label": "USD", "V0_conv": V0_conv_USD},
        "EUR": {"K": K_EUR, "r": r_EUR_prime, "label": "EUR", "V0_conv": V0_conv_EUR},
        "RUB": {"K": K_RUB, "r": r_RUB_prime, "label": "RUB", "V0_conv": V0_conv_RUB}
    }

    # --- –ü–û–ò–°–ö –ò –†–ê–°–ß–ï–¢ –õ–£–ß–®–ï–ô –ö–û–ú–ü–ï–ù–°–ò–†–£–Æ–©–ï–ô –ö–û–†–ó–ò–ù–´ ---

    basket_result = f"‚ö†Ô∏è –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã (V1={Base_Label} {Base_V0:.2f}) –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –ù–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–π –ø–∞—Ä—ã."

    compensating_pairs = []
    currency_list = list(currencies.values())

    for i in range(len(currency_list)):
        for j in range(i + 1, len(currency_list)):
            c1_data = currency_list[i]
            c2_data = currency_list[j]

            K1 = c1_data["K"]
            K2 = c2_data["K"]

            if (K1 - 1) * (K2 - 1) < -EPSILON:
                if K1 > K2:
                    X, Y = c1_data, c2_data
                else:
                    X, Y = c2_data, c1_data

                k_diff = abs(X["K"] - Y["K"])

                compensating_pairs.append({"X": X, "Y": Y, "K_diff": k_diff})

    if compensating_pairs:
        best_pair = max(compensating_pairs, key=lambda p: p["K_diff"])
        best_X = best_pair["X"]
        best_Y = best_pair["Y"]

        target_K = 1.0
        K_X = best_X["K"]
        K_Y = best_Y["K"]

        P = (-(K_Y - target_K)) / ((K_X - target_K))

        V_Y_base = Base_V0 / (P + 1)
        V_X_base = P * V_Y_base

        Percent_X = (V_X_base / Base_V0) * 100
        Percent_Y = (V_Y_base / Base_V0) * 100

        y = V_X_base / best_X["V0_conv"]
        z = V_Y_base / best_Y["V0_conv"]

        V0_check = V_X_base + V_Y_base
        V1_check = (V_X_base * K_X) + (V_Y_base * K_Y)

        warning = ""
        if len(compensating_pairs) > 1:
            all_pairs_str = ", ".join([f"{p['X']['label']}/{p['Y']['label']}" for p in compensating_pairs])
            warning = f"\n–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏—Ö –ø–∞—Ä ({all_pairs_str}). –í—ã–±—Ä–∞–Ω–∞ –ø–∞—Ä–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —Ä–∞–∑–Ω–∏—Ü–µ–π K ({best_X['label']}/{best_Y['label']})."

        basket_result = f"""
–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞: **{best_X['label']}** (–†–æ—Å—Ç, K={K_X:.4f}) –∏ **{best_Y['label']}** (–ü–∞–¥–µ–Ω–∏–µ, K={K_Y:.4f})
–†–∞–∑–Ω–∏—Ü–∞ K (|K_X - K_Y|): {best_pair['K_diff']:.5f}
--------------------------------------------------
–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤ {best_X['label']} (y): {y:.2f} {best_X['label']} ({V_X_base:.2f} {Base_Label}, **{Percent_X:.2f}%** –æ—Ç V0)
–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤ {best_Y['label']} (z): {z:.2f} {best_Y['label']} ({V_Y_base:.2f} {Base_Label}, **{Percent_Y:.2f}%** –æ—Ç V0)
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ (P, V_X_base/V_Y_base): {P:.5f}
--------------------------------------------------
–ü—Ä–æ–≤–µ—Ä–∫–∞ V0 (–ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å): {V0_check:.2f} {Base_Label}
–ü—Ä–æ–≤–µ—Ä–∫–∞ V1 (–ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å): {V1_check:.2f} {Base_Label}
{warning}
"""
    else:
        k_values = {k: v['K'] for k, v in currencies.items()}
        k_min = min(k_values.values())
        k_max = max(k_values.values())

        if k_max < 1.0 - EPSILON:
            basket_result = f"‚ö†Ô∏è –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã (V1=V0) –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –í—Å–µ –∞–∫—Ç–∏–≤—ã –ø–∞–¥–∞—é—Ç (K < 1.0). –î–∏–∞–ø–∞–∑–æ–Ω K: {k_min * 100:.2f}% - {k_max * 100:.2f}%."
        elif k_min > 1.0 + EPSILON:
            basket_result = f"‚ö†Ô∏è –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã (V1=V0) –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –í—Å–µ –∞–∫—Ç–∏–≤—ã —Ä–∞—Å—Ç—É—Ç (K > 1.0). –î–∏–∞–ø–∞–∑–æ–Ω K: {k_min * 100:.2f}% - {k_max * 100:.2f}%."
        else:
            basket_result = "‚ö†Ô∏è –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã (V1=V0) –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –ù–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–π –ø–∞—Ä—ã."

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –¥–ª—è –†–∞–∑–¥–µ–ª–∞ 1
    report_stage1_full = f"""
## 1. ‚öñÔ∏è –ö–£–†–°–û–í–ê–Ø –ö–û–ú–ü–ï–ù–°–ê–¶–ò–Ø (USD/EUR/RUB, V1=V0)
*–í–ù–ò–ú–ê–ù–ò–ï: C_Corr —Ä–∞—Å—Å—á–∏—Ç–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ü–ï–†–ï–ë–†–û–°–ê –ü–†–ï–ú–ò–ò RUB*
–ë–∞–∑–æ–≤–∞—è –≤–∞–ª—é—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ V1=V0: **{Base_Label}** (V0={Base_V0:.2f} {Base_Label})
--------------------------------------------------
1. –†–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞–≤–æ–∫ –¶–ë (C_Base):
C_Base_EUR (i_USD - i_EUR): {C_Base_EUR * 100:.2f}%
C_Base_RUB (i_RUB - i_USD): {C_Base_RUB_Report * 100:.2f}%
2. –†–∞–∑–Ω–∏—Ü–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –æ–±–ª–∏–≥–∞—Ü–∏–π (C_Corr, —Å –ü–ï–†–ï–ë–†–û–°–ö–û–ô r'):
C_Corr_EUR (r'_USD - r'_EUR): {C_Corr_EUR * 100:.2f}%
C_Corr_RUB (r'_RUB - r'_USD): {C_Corr_RUB * 100:.2f}%
--------------------------------------------------
–û–ë–©–ï–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ö–£–†–°–ê (Delta = C_Base + C_Corr):
Delta_EURUSD: {Delta_EURUSD * 100:.2f}%
Delta_USDRUB: {Delta_USDRUB * 100:.2f}%
--------------------------------------------------
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ä–æ—Å—Ç–∞ K_USD (–¢–æ–ª—å–∫–æ –∫—É—Ä—Å, –≤ {Base_Label}): {K_USD:.4f} ({K_USD * 100 - 100:.2f}%)
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ä–æ—Å—Ç–∞ K_EUR (–¢–æ–ª—å–∫–æ –∫—É—Ä—Å, –≤ {Base_Label}): {K_EUR:.4f} ({K_EUR * 100 - 100:.2f}%)
–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ä–æ—Å—Ç–∞ K_RUB (–¢–æ–ª—å–∫–æ –∫—É—Ä—Å, –≤ {Base_Label}): {K_RUB:.4f} ({K_RUB * 100 - 100:.2f}%)
--------------------------------------------------
{basket_result}
"""
    return report_stage1_full, E1


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø 2: –î–í–£–•–≠–¢–ê–ü–ù–´–ô –ü–ê–†–ò–¢–ï–¢ (–†–∞–∑–¥–µ–ª—ã 2 –∏ 3)
# ====================================================================
def calculate_eur_usd_basket(V0_usd, E0, driving_force_usd, driving_force_eur, stage_label, delta_label, E_next_label):
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É EUR/USD –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 50%/50% –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–¥–Ω–æ–π –¥–≤–∏–∂—É—â–µ–π —Å–∏–ª—ã.
    """

    # 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–≤–∏–∂—É—â–µ–π —Å–∏–ª—ã –∫—É—Ä—Å–∞ (Delta)
    delta = driving_force_usd - driving_force_eur

    # 2. –†–∞—Å—á–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∫—É—Ä—Å–∞ (E_next)
    E_next = E0 * (1 + delta)

    # 3. –†–∞—Å—á–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è (x - –¥–æ–ª—è USD –≤ V0)
    # x = 1 - 0.5 * (E0 / E_next)
    x = 1 - 0.5 * (E0 / E_next)

    # 4. –†–∞—Å—á–µ—Ç —Å—É–º–º –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
    if x < -EPSILON or x > 1 + EPSILON:
        is_possible = False
        x = max(0, min(1, x))  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤ –æ—Ç—á–µ—Ç–µ
    else:
        is_possible = True

    # –°—É–º–º—ã V0 –≤ USD
    V0_USD = x * V0_usd
    V0_EUR_in_USD = (1 - x) * V0_usd

    # –°—É–º–º–∞ –≤ –Ω–∞—Ç–∏–≤–Ω—ã—Ö EUR
    y_EUR = V0_EUR_in_USD / E0

    # –°—É–º–º—ã V1
    V1_USD = V0_USD * 1.0
    V1_EUR_in_USD = V0_EUR_in_USD * (E_next / E0)
    V1_Total = V1_USD + V1_EUR_in_USD

    # 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
    if is_possible:
        basket_report = f"""
–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (V0) –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è V1_USD=V1_EUR:
* **USD:** {V0_USD:.2f} USD (**{x * 100:.2f}%** –æ—Ç V0)
* **EUR:** {y_EUR:.2f} EUR ({V0_EUR_in_USD:.2f} USD, **{(1 - x) * 100:.2f}%** –æ—Ç V0)

–ü—Ä–æ–≤–µ—Ä–∫–∞ V1 (–ö–æ–Ω–µ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å):
* **V1_Total (–≤ USD):** {V1_Total:.2f} USD
* **V1_USD:** {V1_USD:.2f} USD ({V1_USD / V1_Total * 100:.2f}%)
* **V1_EUR:** {V1_EUR_in_USD:.2f} USD ({V1_EUR_in_USD / V1_Total * 100:.2f}%)
"""
    else:
        basket_report = f"""
‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–µ–≤–æ–≥–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è 50% EUR / 50% USD, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –¥–≤–µ –≤–∞–ª—é—Ç—ã.
–¢—Ä–µ–±—É–µ–º–∞—è –¥–æ–ª—è USD ({x * 100:.2f}%) –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞ [0%, 100%].
"""

    report = f"""
## {stage_label}
* **–ù–∞—á–∞–ª—å–Ω—ã–π –∫—É—Ä—Å EURUSD (E0):** {E0:.5f}
* **{delta_label}:** {delta * 100:.2f}%
* **{E_next_label}:** {E_next:.5f}
* **–¶–µ–ª—å:** –î–æ—Å—Ç–∏—á—å 50% USD / 50% EUR –ø—Ä–∏ —Ü–µ–ª–µ–≤–æ–º –∫—É—Ä—Å–µ.
---
{basket_report}
"""
    return report, E_next


# ====================================================================
# –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° –ò –õ–û–ì–ò–ö–ê
# ====================================================================
class CurrencyCalculatorApp(ctk.CTk):
    def __init__(self):
        super().__init__()

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫–Ω–∞
        self.title("–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –í–∞–ª—é—Ç–Ω–æ–π –ö–æ—Ä–∑–∏–Ω—ã (–ü–æ–ª–Ω—ã–π –ê–Ω–∞–ª–∏–∑)")
        self.geometry("900x950")
        self.grid_columnconfigure(0, weight=1)
        self.grid_rowconfigure(4, weight=1)

        # --- –§–†–ï–ô–ú–´ –î–õ–Ø –í–í–û–î–ê ---
        self.input_frame = ctk.CTkFrame(self)
        self.input_frame.grid(row=0, column=0, padx=20, pady=(20, 10), sticky="ew")
        self.input_frame.grid_columnconfigure((0, 1, 2, 3, 4, 5, 6, 7), weight=1)

        self.entries = {}

        # --- –ë–õ–û–ö 1: –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ---
        self.create_input_block(
            frame=self.input_frame,
            title="–ò—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã",
            row_start=0,
            col_start=0,
            values={
                "V0 (–ö–∞–ø–∏—Ç–∞–ª, USD)": "300.0",
                "E0 (EURUSD, t=0)": "1.16220",
                "R0 (USDRUB, t=0)": "81.12",
            }
        )

        # --- –ë–õ–û–ö 2: –°—Ç–∞–≤–∫–∏ –¶–ë (i) ---
        self.create_input_block(
            frame=self.input_frame,
            title="–°—Ç–∞–≤–∫–∏ –¶–ë (i, %)",
            row_start=0,
            col_start=3,
            values={
                "i_USD (%)": "4.00",
                "i_EUR (%)": "2.15",
                "i_RUB (%)": "16.50",
            }
        )

        # --- –ë–õ–û–ö 3: –ü—Ä–µ–º–∏–∏ –∑–∞ —Ä–∏—Å–∫ (p) ---
        self.bond_frame = ctk.CTkFrame(self)
        self.bond_frame.grid(row=1, column=0, padx=20, pady=10, sticky="ew")
        self.bond_frame.grid_columnconfigure((0, 1, 2, 3, 4, 5, 6, 7, 8, 9), weight=1)

        self.create_input_block(
            frame=self.bond_frame,
            title="–ü—Ä–µ–º–∏–∏ –∑–∞ —Ä–∏—Å–∫ (p, %)",
            row_start=0,
            col_start=0,
            values={
                "p_USD (%)": "2.00",
                "p_EUR (%)": "2.55",
                "p_RUB (%)": "3.50",
            },
            single_row=True
        )

        # --- –ë–õ–û–ö 4: –í—ã–±–æ—Ä –ë–∞–∑–æ–≤–æ–π –í–∞–ª—é—Ç—ã –¥–ª—è –†–∞–∑–¥–µ–ª–∞ 1 (–≤–ª–∏—è–µ—Ç –Ω–∞ r_RUB!) ---
        self.base_label = ctk.CTkLabel(self.bond_frame, text="–ë–∞–∑–∞ –¥–ª—è –†.1:", font=ctk.CTkFont(weight="bold"))
        self.base_label.grid(row=0, column=7, padx=10, pady=5, sticky="w")
        self.base_currency_var = ctk.StringVar(value="USD")  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ USD –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self.base_currency_option = ctk.CTkOptionMenu(self.bond_frame,
                                                      values=["USD", "EUR"],
                                                      variable=self.base_currency_var,
                                                      width=80)
        self.base_currency_option.grid(row=0, column=8, padx=(0, 10), pady=5, sticky="e")

        # –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
        self.calculate_button = ctk.CTkButton(self, text="–†–ê–°–°–ß–ò–¢–ê–¢–¨ –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó", command=self.run_calculation)
        self.calculate_button.grid(row=2, column=0, padx=20, pady=10, sticky="ew")

        # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        ctk.CTkLabel(self, text="–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç:").grid(row=3, column=0, padx=20, pady=(10, 0), sticky="nw")
        self.result_text = ctk.CTkTextbox(self, height=600, font=ctk.CTkFont(family="Consolas", size=14))
        self.result_text.grid(row=4, column=0, padx=20, pady=(0, 20), sticky="nsew")

        # –í—Å—Ç–∞–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ø–æ—è—Å–Ω–µ–Ω–∏—è
        self.insert_initial_explanation()

    def insert_initial_explanation(self):
        """–í—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –æ —Ä–∞–±–æ—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã."""
        initial_explanation = """
==================================================
             –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –í–ê–õ–Æ–¢–ù–û–ô –ö–û–†–ó–ò–ù–´
==================================================
*** –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó (3 –†–ê–ó–î–ï–õ–ê) ***

**–†–∞–∑–¥–µ–ª 1 (–ö—É—Ä—Å–æ–≤–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è V1=V0):**
    - –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å r' —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ü–ï–†–ï–ë–†–û–°–û–ú –ü–†–ï–ú–ò–ò RUB.

**–†–∞–∑–¥–µ–ª 3 (–ü–∞—Ä–∏—Ç–µ—Ç –î–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π):**
    - –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å r_R3 —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ü–ï–†–ï–ö–†–ï–°–¢–ù–´–ú –ü–ï–†–ï–ë–†–û–°–û–ú –ü–†–ï–ú–ò–ô EUR/USD.

–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ '–†–ê–°–°–ß–ò–¢–ê–¢–¨'.
"""
        self.result_text.delete("1.0", ctk.END)
        self.result_text.insert("1.0", initial_explanation)

    def create_input_block(self, frame, title, row_start, col_start, values, single_row=False):
        """–°–æ–∑–¥–∞–µ—Ç –±–ª–æ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞."""
        ctk.CTkLabel(frame, text=title, font=ctk.CTkFont(weight="bold")).grid(
            row=row_start, column=col_start, columnspan=2, padx=10, pady=(10, 5), sticky="w"
        )
        current_row = row_start + 1
        current_col = col_start

        for label, default_value in values.items():
            ctk.CTkLabel(frame, text=label).grid(row=current_row, column=current_col, padx=(10, 0), pady=5, sticky="w")

            entry = ctk.CTkEntry(frame, width=80)
            entry.insert(0, default_value)
            entry.grid(row=current_row, column=current_col + 1, padx=(0, 10), pady=5, sticky="e")
            self.entries[label] = entry

            if single_row:
                current_col += 2
            else:
                current_row += 1

    def run_calculation(self):
        """–°—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø—É—Å–∫–∞–µ—Ç –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
        try:
            # 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            data = {}
            for label, entry in self.entries.items():
                data[label] = float(entry.get().replace(',', '.'))

            base_currency = self.base_currency_var.get()

            # 2. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –≤ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            i_USD = data["i_USD (%)"] / 100
            i_EUR = data["i_EUR (%)"] / 100
            i_RUB = data["i_RUB (%)"] / 100
            
            p_USD = data["p_USD (%)"] / 100
            p_EUR = data["p_EUR (%)"] / 100
            p_RUB = data["p_RUB (%)"] / 100
            
            # 3. –í–´–ß–ò–°–õ–ï–ù–ò–ï –°–ö–û–†–†–ï–ö–¢–ò–†–û–í–ê–ù–ù–´–• –î–û–•–û–î–ù–û–°–¢–ï–ô
            
            # 3.1. r' (–î–ª—è –†–∞–∑–¥–µ–ª–∞ 1 - –ö—É—Ä—Å–æ–≤–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è - —Å –ü–ï–†–ï–ë–†–û–°–û–ú RUB)
            # r'_USD = i_USD + p_RUB
            # r'_EUR = i_EUR + p_RUB
            # r'_RUB = i_RUB + p_USD (–µ—Å–ª–∏ –±–∞–∑–∞ USD) –ò–õ–ò r'_RUB = i_RUB + p_EUR (–µ—Å–ª–∏ –±–∞–∑–∞ EUR)

            r_USD_prime = i_USD + p_RUB
            r_EUR_prime = i_EUR + p_RUB
            
            if base_currency == "USD":
                r_RUB_prime = i_RUB + p_USD
            elif base_currency == "EUR":
                r_RUB_prime = i_RUB + p_EUR
            else:
                r_RUB_prime = i_RUB + p_USD
                
            # 3.2. r_R3 (–î–ª—è –†–∞–∑–¥–µ–ª–∞ 3 - –ü–∞—Ä–∏—Ç–µ—Ç –î–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π - —Å –ü–ï–†–ï–ö–†–ï–°–¢–ù–´–ú –ü–ï–†–ï–ë–†–û–°–û–ú EUR/USD)
            # r_USD_R3 = i_USD + p_EUR
            # r_EUR_R3 = i_EUR + p_USD
            
            r_USD_R3 = i_USD + p_EUR
            r_EUR_R3 = i_EUR + p_USD

            # 3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞: r >= i (—á—Ç–æ –ø—Ä–µ–º–∏—è >= 0)
            corrections = []
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è r' (–†–∞–∑–¥–µ–ª 1)
            if r_USD_prime < i_USD: 
                r_USD_prime = i_USD
                corrections.append(f"r'_USD (–±—ã–ª {r_USD_prime * 100:.2f}%) —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ i_USD ({i_USD * 100:.2f}%)")
            if r_EUR_prime < i_EUR:
                r_EUR_prime = i_EUR
                corrections.append(f"r'_EUR (–±—ã–ª {r_EUR_prime * 100:.2f}%) —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ i_EUR ({i_EUR * 100:.2f}%)")
            if r_RUB_prime < i_RUB:
                r_RUB_prime = i_RUB
                corrections.append(f"r'_RUB (–±—ã–ª {r_RUB_prime * 100:.2f}%) —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ i_RUB ({i_RUB * 100:.2f}%)")
                
            # –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è r_R3 (–†–∞–∑–¥–µ–ª 3)
            if r_USD_R3 < i_USD:
                r_USD_R3 = i_USD
                corrections.append(f"r_USD_R3 (–±—ã–ª {r_USD_R3 * 100:.2f}%) —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ i_USD ({i_USD * 100:.2f}%)")
            if r_EUR_R3 < i_EUR:
                r_EUR_R3 = i_EUR
                corrections.append(f"r_EUR_R3 (–±—ã–ª {r_EUR_R3 * 100:.2f}%) —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ i_EUR ({i_EUR * 100:.2f}%)")

            correction_note = ""
            if corrections:
                correction_note = "\n!!! –ü–†–ê–í–ò–õ–û –ö–û–†–†–ï–ö–¶–ò–ò –î–û–•–û–î–ù–û–°–¢–ò –ü–†–ò–ú–ï–ù–ï–ù–û (r < i) !!!\n" + "\n".join(
                    corrections) + "\n--------------------------------------------------\n"

            V0 = data["V0 (–ö–∞–ø–∏—Ç–∞–ª, USD)"]
            E0 = data["E0 (EURUSD, t=0)"]
            R0 = data["R0 (USDRUB, t=0)"]

            # ====================================================================
            # –†–ê–ó–î–ï–õ 1: –ö—É—Ä—Å–æ–≤–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (V1=V0)
            # –ü–µ—Ä–µ–¥–∞–µ–º r' (—Å –ø–µ—Ä–µ–±—Ä–æ—Å–æ–º RUB)
            # ====================================================================
            report_R1, E1_from_R1 = calculate_compensating_basket(
                V0, E0, R0, i_USD, i_EUR, i_RUB, r_USD_prime, r_EUR_prime, r_RUB_prime, base_currency
            )

            # ====================================================================
            # –†–ê–ó–î–ï–õ 2: –ü–∞—Ä–∏—Ç–µ—Ç –°—Ç–∞–≤–æ–∫ –¶–ë (–¶–µ–ª—å 50/50)
            # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç i_USD, i_EUR
            # ====================================================================
            report_R2, E1_from_R2 = calculate_eur_usd_basket(
                V0, E0, i_USD, i_EUR,
                "2. üí∞ –†–ê–°–ß–ï–¢ –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ô –ö–û–†–ó–ò–ù–´ (–≠–¢–ê–ü 1: –ü–ê–†–ò–¢–ï–¢ –°–¢–ê–í–û–ö –¶–ë)",
                "–†–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞–≤–æ–∫ –¶–ë (i_USD - i_EUR)",
                "–û–∂–∏–¥–∞–µ–º—ã–π –∫—É—Ä—Å EURUSD (E1)"
            )

            # ====================================================================
            # –†–ê–ó–î–ï–õ 3: –ü–∞—Ä–∏—Ç–µ—Ç –î–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π –û–±–ª–∏–≥–∞—Ü–∏–π (–¶–µ–ª—å 50/50)
            # –ü–µ—Ä–µ–¥–∞–µ–º r_R3 (—Å –ü–ï–†–ï–ö–†–ï–°–¢–ù–´–ú –ø–µ—Ä–µ–±—Ä–æ—Å–æ–º EUR/USD)
            # ====================================================================
            report_R3, _ = calculate_eur_usd_basket(
                V0, E1_from_R2, r_USD_R3, r_EUR_R3,
                "3. üìà –†–ê–°–ß–ï–¢ –û–ü–¢–ò–ú–ê–õ–¨–ù–û–ô –ö–û–†–ó–ò–ù–´ (–≠–¢–ê–ü 2: –ü–ê–†–ò–¢–ï–¢ –î–û–•–û–î–ù–û–°–¢–ï–ô –û–ë–õ–ò–ì–ê–¶–ò–ô)",
                "–†–∞–∑–Ω–∏—Ü–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π –æ–±–ª–∏–≥–∞—Ü–∏–π (r_USD - r_EUR) —Å –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω—ã–º –ø–µ—Ä–µ–±—Ä–æ—Å–æ–º",
                "–û–∂–∏–¥–∞–µ–º—ã–π-–æ–∂–∏–¥–∞–µ–º—ã–π –∫—É—Ä—Å EURUSD (E1.1)"
            )

            # 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            final_report = f"""
==================================================
             –û–¢–ß–ï–¢ –ê–ù–ê–õ–ò–ó–ê –í–ê–õ–Æ–¢–ù–´–• –ö–û–†–ó–ò–ù
==================================================
–í–≤–µ–¥–µ–Ω–Ω—ã–µ –ø—Ä–µ–º–∏–∏ (p): p_USD={p_USD*100:.2f}%, p_EUR={p_EUR*100:.2f}%, p_RUB={p_RUB*100:.2f}%
--------------------------------------------------
–í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (–†–∞–∑–¥–µ–ª 1 - r', –ø–µ—Ä–µ–±—Ä–æ—Å RUB): 
r'_USD={r_USD_prime*100:.2f}%, r'_EUR={r_EUR_prime*100:.2f}%, r'_RUB={r_RUB_prime*100:.2f}%
–í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (–†–∞–∑–¥–µ–ª 3 - r_R3, –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–Ω—ã–π –ø–µ—Ä–µ–±—Ä–æ—Å EUR/USD):
r_USD_R3={r_USD_R3*100:.2f}%, r_EUR_R3={r_EUR_R3*100:.2f}%
--------------------------------------------------
{correction_note}
{report_R1}
---
{report_R2}
---
{report_R3}
"""
            self.result_text.delete("1.0", ctk.END)
            self.result_text.insert("1.0", final_report)

        except ValueError:
            self.result_text.delete("1.0", ctk.END)
            self.result_text.insert("1.0",
                                    "–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–∫—É –∫–∞–∫ –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å).")
        except Exception as e:
            self.result_text.delete("1.0", ctk.END)
            self.result_text.insert("1.0", f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    try:
        app = CurrencyCalculatorApp()
        app.mainloop()
    except ImportError:
        print("–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'customtkinter' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ, –≤—ã–ø–æ–ª–Ω–∏–≤: pip install customtkinter")
    except Exception as e:
        print(f"–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞: {e}")
